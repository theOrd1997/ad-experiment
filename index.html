<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>광고 영상 시청 반응 설문</title>
<style>
  :root{
    --gap:14px; --fg:#222; --muted:#666; --line:#e5e7eb; --ok:#0a7c0a; --warn:#b00; --brand:#111;
  }
  html,body{margin:0;padding:0;background:#fff;color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;line-height:1.6}
  .wrap{max-width:860px;margin:24px auto;padding:0 16px}
  h1{font-size:1.4rem;margin:.2rem 0 .5rem}
  .dim{color:var(--muted)}
  .card{border:1px solid var(--line);border-radius:14px;padding:16px;box-shadow:0 1px 4px rgba(0,0,0,.03);margin-top:var(--gap)}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#f2f2f2;font-size:.82rem;margin-right:6px}
  .video-wrap{display:grid;gap:10px}
  video{width:100%;max-height:60vh;background:#000;border-radius:12px}
  .progress{height:8px;background:#eee;border-radius:999px;overflow:hidden}
  .progress>div{height:100%;background:#2f6;width:0%;transition:width .2s}
  .ok{color:var(--ok)}
  .warn{color:var(--warn)}
  .btn{cursor:pointer;border:0;padding:10px 14px;border-radius:10px;background:var(--brand);color:#fff;font-weight:600}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  .row{display:grid;gap:8px;grid-auto-flow:column;justify-content:start}
  .q{margin:14px 0}
  .likert{display:flex;gap:10px;flex-wrap:wrap}
  .likert label{border:1px solid var(--line);padding:6px 10px;border-radius:8px;cursor:pointer}
  .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
</style>
</head>
<body>
  <div class="wrap">
    <h1>광고 영상 시청 반응 설문</h1>
    <p class="dim"><b>각 영상은 끝까지 시청</b>해야 설문으로 이동할 수 있어요.</p>

    <!-- 숨은 iframe: 응답 수신용 -->
    <iframe name="sink" id="sink" title="응답 전송 상태" class="sr-only"></iframe>

    <!-- 숨은 form: 최종 제출용 (data=<JSON>) -->
    <form id="submitForm"
          action="https://script.google.com/macros/s/AKfycbywBmhFjK3CTJ1zqqkUf0n6XtDBwpa8-O5fUPYkZeYLfRUmXO5TdMMiESTjcic3AMphRg/exec"
          method="POST" target="sink" class="sr-only" aria-hidden="true">
      <input type="hidden" name="data" id="payload" />
    </form>

    <div id="stage" class="card">로딩 중…</div>
  </div>

<script>
/* =========================
 * 0) 설정 & 상수
 * ========================= */
const WATCH_THRESHOLD = 0.98;               // 시청률 기준
const SEEK_TOLERANCE = 0.75;                // 초 단위: 강제 점프 허용치
const MAX_PLAYBACK = 1.25;                  // 배속 제한
const SUBMIT_TIMEOUT_MS = 10_000;           // 제출 대기 타임아웃

const videos = [
  { id: "high", label: "영상 A", src: "https://raw.githubusercontent.com/theOrd1997/ad-experiment/main/high_originality.mp4" },
  { id: "low",  label: "영상 B", src: "https://raw.githubusercontent.com/theOrd1997/ad-experiment/main/low_originality.mp4" }
];

// ✅ 문항 2개 추가(독창성/예상 밖 표현)
const questions = [
  "이 광고는 전반적으로 잘 만들어졌다.",
  "이 광고는 브랜드 제품을 잘 표현하였다.",
  "이 광고는 브랜드와 잘 어울린다.",
  "이 광고는 시각적 완성도가 높다.",
  "이 영상은 새롭고 독창적인 아이디어를 보여준다.",
  "이 영상은 예상 밖의 독특한 표현 방식을 담고 있다."
];

/* =========================
 * 1) 공용 유틸
 * ========================= */
const $stage   = document.getElementById('stage');
const $sink    = document.getElementById('sink');
const $form    = document.getElementById('submitForm');
const $payload = document.getElementById('payload');

const sessionId = (crypto?.getRandomValues)
  ? crypto.getRandomValues(new Uint32Array(4)).join('-')
  : String(Date.now());

// Fisher–Yates 셔플
function shuffleInPlace(arr){
  for(let i = arr.length - 1; i > 0; i--){
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

// element 생성 헬퍼
function el(tag, props={}, children=[]){
  const node = document.createElement(tag);
  Object.assign(node, props);
  (Array.isArray(children) ? children : [children]).forEach(c=>{
    if (c==null) return;
    node.appendChild(typeof c === 'string' ? document.createTextNode(c) : c);
  });
  return node;
}

/* =========================
 * 2) 상태
 * ========================= */
const order = shuffleInPlace(videos.slice());
const answers = {};               // { high:[..], low:[..] }
let posting = false;              // 제출 중 플래그
let submitTimer = null;           // 타임아웃 핸들
let stepAbort = null;             // 단계별 이벤트 정리용 AbortController

/* =========================
 * 3) 단계 렌더러
 * ========================= */
function renderVideoStep(item, index, total){
  // 이전 단계 이벤트 정리
  stepAbort?.abort();
  stepAbort = new AbortController();

  $stage.innerHTML = '';
  const header = el('div', { innerHTML: `<span class="badge">${index+1} / ${total}</span><b>${item.label}</b>` });

  const v = el('video', {
    src: item.src, controls: true, playsInline: true, preload: 'metadata'
  });

  const progBar = el('div', { className:'progress', role:'progressbar', 'aria-valuemin':0, 'aria-valuemax':100 });
  const barFill = el('div'); progBar.appendChild(barFill);
  const msg = el('div', { className:'dim', textContent:'영상을 끝까지 시청해주세요.' });
  const nextBtn = el('button', { className:'btn', textContent:'다음 (설문으로 이동)', disabled:true });

  // 시청 추적
  let lastAllowed = 0;
  let duration = 0;
  const watchedSeconds = new Set();

  v.addEventListener('loadedmetadata', ()=>{
    duration = Math.max(0, v.duration || 0);
  }, { signal: stepAbort.signal });

  v.addEventListener('seeking', ()=>{
    if (v.currentTime > lastAllowed + SEEK_TOLERANCE){
      v.currentTime = lastAllowed;
    }
  }, { signal: stepAbort.signal });

  v.addEventListener('ratechange', ()=>{
    if (v.playbackRate > MAX_PLAYBACK) v.playbackRate = MAX_PLAYBACK;
  }, { signal: stepAbort.signal });

  document.addEventListener('visibilitychange', ()=>{
    if (document.hidden && !v.paused) v.pause();
  }, { signal: stepAbort.signal });

  v.addEventListener('error', ()=>{
    msg.className = 'warn';
    msg.textContent = '영상을 불러오지 못했습니다. 네트워크 상태를 확인한 뒤 새로고침 해주세요.';
  }, { signal: stepAbort.signal });

  v.addEventListener('timeupdate', ()=>{
    lastAllowed = Math.max(lastAllowed, v.currentTime);
    watchedSeconds.add(Math.floor(v.currentTime));

    if (duration > 0){
      // 분모 반올림 보정(메타데이터 부정확성 완화)
      const denom = Math.max(1, Math.round(duration));
      const ratio = Math.min(watchedSeconds.size / denom, 1);
      const pct = Math.round(ratio * 100);
      barFill.style.width = pct + '%';
      progBar.setAttribute('aria-valuenow', String(pct));

      const nearEnd = (duration - lastAllowed) <= 2;
      if (ratio >= WATCH_THRESHOLD || nearEnd){
        nextBtn.disabled = false;
        msg.className = 'ok';
        msg.textContent = '시청 완료! 설문으로 이동할 수 있습니다.';
      }
    }
  }, { signal: stepAbort.signal });

  nextBtn.addEventListener('click', ()=>{
    renderSurveyStep(item, index);
  }, { signal: stepAbort.signal });

  const wrap = el('div', { className:'video-wrap' }, [
    header, v, progBar, msg,
    el('div', { className:'row' }, [nextBtn])
  ]);

  $stage.appendChild(wrap);
}

function renderSurveyStep(item, index){
  stepAbort?.abort();
  stepAbort = new AbortController();

  $stage.innerHTML = '';
  const formEl = el('form', { className:'card' });

  const title = el('div', { innerHTML: `<span class="badge">${index+1} / ${order.length}</span><b>${item.label} — 설문</b>` });
  formEl.appendChild(title);

  questions.forEach((q,i)=>{
    const id = `${item.id}_q${i}`;
    const block = el('div', { className:'q' });
    block.appendChild(el('div', { textContent: q }));

    const likert = el('div', { className:'likert' });
    for (let v=1; v<=5; v++){
      const input = el('input', { type:'radio', name:id, value:String(v), required:true, id:`${id}_${v}` });
      const lab = el('label', { htmlFor:`${id}_${v}`, innerHTML: `${v}` });
      const cell = el('div', {}, [input, lab]);
      likert.appendChild(el('label', {}, [input, ` ${v}`]));
    }
    block.appendChild(likert);
    formEl.appendChild(block);
  });

  const backBtn = el('button', { type:'button', className:'btn', textContent:'이전 (영상 다시 보기)' });
  const nextBtn = el('button', { type:'submit', className:'btn',
    textContent: (index === order.length - 1) ? '최종 제출' : '다음 영상으로'
  });

  formEl.appendChild(el('div', { className:'row' }, [backBtn, nextBtn]));

  formEl.addEventListener('submit', (e)=>{
    e.preventDefault();
    const vals = [];
    let ok = true;

    questions.forEach((_,i)=>{
      const picked = formEl.querySelector(`input[name="${item.id}_q${i}"]:checked`);
      if (!picked) ok = false;
      else vals.push(Number(picked.value));
    });

    if (!ok){
      alert('모든 문항에 응답해주세요.');
      return;
    }

    answers[item.id] = vals;

    if (index === order.length - 1){
      submitAll();
    } else {
      renderVideoStep(order[index+1], index+1, order.length);
    }
  }, { signal: stepAbort.signal });

  backBtn.addEventListener('click', ()=>{
    renderVideoStep(item, index, order.length);
  }, { signal: stepAbort.signal });

  $stage.appendChild(formEl);
}

/* =========================
 * 4) 제출 로직 (hidden form + iframe)
 * ========================= */
function submitAll(){
  if (posting) return; // 이중 제출 방지
  posting = true;

  const payload = {
    sessionId,
    userAgent: navigator.userAgent,
    order: order.map(o=>o.id),
    answers,
    timestamp: new Date().toISOString()
  };

  $payload.value = JSON.stringify(payload);

  // UI: 진행중
  $stage.innerHTML = `
    <div class="card">
      <p>제출 중…</p>
      <p class="dim">창을 닫지 말고 잠시만 기다려주세요.</p>
    </div>
  `;

  // 폴백 타임아웃
  submitTimer = setTimeout(()=>{
    if (!posting) return;
    posting = false;
    $stage.innerHTML = `
      <div class="card">
        <p class="warn">제출 확인 신호가 지연되고 있습니다.</p>
        <p class="dim">네트워크 상태를 확인하시거나, 잠시 후 다시 시도해주세요.<br/>응답은 중복 제출되어도 서버에서 처리됩니다.</p>
      </div>
    `;
  }, SUBMIT_TIMEOUT_MS);

  $form.submit();
}

// iframe onload → 성공 처리
$sink.addEventListener('load', ()=>{
  if (!posting) return;               // 초기 onload 무시
  posting = false;
  clearTimeout(submitTimer);
  $stage.innerHTML = `
    <div class="card">
      <p class="ok">제출이 완료되었습니다. 감사합니다!</p>
      <div class="dim">응답이 스프레드시트에 저장되었습니다.</div>
    </div>
  `;
});

/* =========================
 * 5) 시작
 * ========================= */
renderVideoStep(order[0], 0, order.length);
</script>
</body>
</html>
