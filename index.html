<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>광고 영상 시청 반응 설문</title>

<!-- 캐시 무력화(정적 호스팅 시 구버전 잔존 방지) -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />

<style>
  :root{
    --gap:14px; --fg:#222; --muted:#666; --line:#e5e7eb; --ok:#0a7c0a; --warn:#b00; --brand:#111;
    --pill:#f6f7fb; --pill-border:#d9ddea; --pill-checked:#111; --pill-checked-fg:#fff;
    --focus:#3b82f6;
  }
  html,body{margin:0;padding:0;background:#fff;color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;line-height:1.6}
  .wrap{max-width:860px;margin:24px auto;padding:0 16px}
  h1{font-size:1.4rem;margin:.2rem 0 .5rem}
  .dim{color:var(--muted)}
  .card{border:1px solid var(--line);border-radius:14px;padding:16px;box-shadow:0 1px 4px rgba(0,0,0,.03);margin-top:var(--gap)}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#f2f2f2;font-size:.82rem;margin-right:6px}
  .video-wrap{display:grid;gap:10px}
  video{width:100%;max-height:60vh;background:#000;border-radius:12px}
  .progress{height:8px;background:#eee;border-radius:999px;overflow:hidden}
  .progress>div{height:100%;background:#2f6;width:0%;transition:width .2s}
  .ok{color:var(--ok)}
  .warn{color:var(--warn)}
  .btn{cursor:pointer;border:0;padding:12px 16px;border-radius:12px;background:var(--brand);color:#fff;font-weight:700}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  .row{display:grid;gap:8px;grid-auto-flow:column;justify-content:start}
  .q{margin:16px 0}

  /* ===== Likert (모바일 친화 + 터치 타깃 확대) ===== */
  .likert-wrap{margin-top:8px}
  .likert{
    display:grid;
    grid-template-columns: repeat(5, minmax(54px, 1fr));
    gap:10px;
    align-items:stretch;
    user-select:none;
    /* 아주 작은 화면에서 좌우 스크롤 허용 */
    overflow-x:auto;
    padding-bottom:4px;
    scroll-snap-type:x mandatory;
  }
  /* 내부 그리드는 최소 너비 보장 → 320px 이하에서도 스크롤 복원력 좋음 */
  .likert-inner{
    display:contents; /* grid 그대로 상속 */
    min-width: 340px;
  }
  .pill{
    display:flex; align-items:center; justify-content:center;
    border:1px solid var(--pill-border);
    background:var(--pill);
    color:#111; font-weight:600;
    border-radius:12px; padding:12px 10px;
    scroll-snap-align:center;
    position:relative;
    min-height:44px; /* 터치 타깃 */
    transition:transform .08s ease, box-shadow .08s ease, background .12s ease;
  }
  .pill:hover{box-shadow:0 1px 4px rgba(0,0,0,.06)}
  .pill:active{transform:scale(.98)}
  .pill input[type="radio"]{
    position:absolute; inset:0; opacity:0; cursor:pointer;
  }
  /* checked 스타일: :has()는 최신 모바일/데스크톱 대부분 지원 */
  .pill:has(input:checked){
    background:var(--pill-checked);
    color:var(--pill-checked-fg);
    border-color:var(--pill-checked);
  }
  .pill:has(input:focus-visible){
    outline:2px solid var(--focus); outline-offset:2px;
  }

  /* 보조 앵커 텍스트 (1·3·5) */
  .likert-legend{
    display:grid; grid-template-columns: repeat(5, minmax(44px, 1fr)); gap:10px;
    font-size:.86rem; color:var(--muted); margin-top:6px;
  }
  .likert-legend span{text-align:center}

  /* 좁은 화면: 글자 줄임/간격 조정 */
  @media (max-width: 420px){
    .wrap{padding:0 12px}
    .btn{padding:11px 14px; border-radius:10px}
    .pill{padding:11px 8px; font-weight:700}
    .likert-legend{font-size:.8rem}
  }

  /* 설문 블록 세부 타이포(가독성) */
  .q-title{font-weight:700; line-height:1.5}
  .q-hint{color:var(--muted); font-size:.92rem; margin-top:4px}

  /* 섹션 푸터(버튼 영역) 고정 안전 여백 */
  .actions{position:sticky; bottom:0; background:#fff; padding-top:12px}
  .actions::before{content:""; display:block; height:1px; background:var(--line); margin-bottom:12px}
</style>
</head>
<body>
  <div class="wrap">
    <h1>광고 영상 시청 반응 설문</h1>
    <p class="dim"><b>각 영상은 끝까지 시청</b>해야 설문으로 이동할 수 있어요.</p>

    <!-- 숨은 iframe: 응답 수신용 -->
    <iframe name="sink" id="sink" title="응답 전송 상태" class="sr-only"></iframe>

    <!-- 숨은 form: 최종 제출용 (data=<JSON>) -->
    <form id="submitForm"
          action="https://script.google.com/macros/s/AKfycbywBmhFjK3CTJ1zqqkUf0n6XtDBwpa8-O5fUPYkZeYLfRUmXO5TdMMiESTjcic3AMphRg/exec"
          method="POST" target="sink" class="sr-only" aria-hidden="true">
      <input type="hidden" name="data" id="payload" />
    </form>

    <div id="stage" class="card">로딩 중…</div>
  </div>

<script>
/* =========================
 * 0) 설정 & 상수
 * ========================= */
const WATCH_THRESHOLD = 0.98;   // 시청률 기준
const SEEK_TOLERANCE = 0.75;    // 초 단위: 강제 점프 허용치
const MAX_PLAYBACK = 1.25;      // 배속 제한
const SUBMIT_TIMEOUT_MS = 10_000;

const videos = [
  { id: "high", label: "영상 A", src: "https://raw.githubusercontent.com/theOrd1997/ad-experiment/main/high_originality.mp4" },
  { id: "low",  label: "영상 B", src: "https://raw.githubusercontent.com/theOrd1997/ad-experiment/main/low_originality.mp4" }
];

// ✅ 6문항(품질 4 + 독창성 2)
const questions = [
  "이 광고는 전반적으로 잘 만들어졌다.",
  "이 광고는 브랜드 제품을 잘 표현하였다.",
  "이 광고는 브랜드와 잘 어울린다.",
  "이 광고는 시각적 완성도가 높다.",
  "이 영상은 새롭고 독창적인 아이디어를 보여준다.",
  "이 영상은 예상 밖의 독특한 표현 방식을 담고 있다."
];

/* =========================
 * 1) 공용 유틸
 * ========================= */
const $stage   = document.getElementById('stage');
const $sink    = document.getElementById('sink');
const $form    = document.getElementById('submitForm');
const $payload = document.getElementById('payload');

const sessionId = (crypto?.getRandomValues)
  ? crypto.getRandomValues(new Uint32Array(4)).join('-')
  : String(Date.now());

function shuffleInPlace(arr){
  for(let i = arr.length - 1; i > 0; i--){
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

function el(tag, props={}, children=[]){
  const node = document.createElement(tag);
  Object.assign(node, props);
  (Array.isArray(children) ? children : [children]).forEach(c=>{
    if (c==null) return;
    node.appendChild(typeof c === 'string' ? document.createTextNode(c) : c);
  });
  return node;
}

/* =========================
 * 2) 상태
 * ========================= */
const order = shuffleInPlace(videos.slice());
const answers = {};               // { high:[..6], low:[..6] }
let posting = false;
let submitTimer = null;
let stepAbort = null;

/* =========================
 * 3) 단계 렌더러
 * ========================= */
function renderVideoStep(item, index, total){
  stepAbort?.abort();
  stepAbort = new AbortController();

  $stage.innerHTML = '';
  const header = el('div', { innerHTML: `<span class="badge">${index+1} / ${total}</span><b>${item.label}</b>` });

  const v = el('video', { src:item.src, controls:true, playsInline:true, preload:'metadata' });

  const progBar = el('div', { className:'progress', role:'progressbar', 'aria-valuemin':0, 'aria-valuemax':100 });
  const barFill = el('div'); progBar.appendChild(barFill);
  const msg = el('div', { className:'dim', textContent:'영상을 끝까지 시청해주세요.' });
  const nextBtn = el('button', { className:'btn', textContent:'다음 (설문으로 이동)', disabled:true });

  let lastAllowed = 0;
  let duration = 0;
  const watchedSeconds = new Set();

  v.addEventListener('loadedmetadata', ()=>{ duration = Math.max(0, v.duration || 0); }, { signal: stepAbort.signal });
  v.addEventListener('seeking', ()=>{ if (v.currentTime > lastAllowed + SEEK_TOLERANCE) v.currentTime = lastAllowed; }, { signal: stepAbort.signal });
  v.addEventListener('ratechange', ()=>{ if (v.playbackRate > MAX_PLAYBACK) v.playbackRate = MAX_PLAYBACK; }, { signal: stepAbort.signal });
  document.addEventListener('visibilitychange', ()=>{ if (document.hidden && !v.paused) v.pause(); }, { signal: stepAbort.signal });
  v.addEventListener('error', ()=>{ msg.className='warn'; msg.textContent='영상을 불러오지 못했습니다. 네트워크 상태를 확인한 뒤 새로고침 해주세요.'; }, { signal: stepAbort.signal });

  v.addEventListener('timeupdate', ()=>{
    lastAllowed = Math.max(lastAllowed, v.currentTime);
    watchedSeconds.add(Math.floor(v.currentTime));
    if (duration > 0){
      const denom = Math.max(1, Math.round(duration));
      const ratio = Math.min(watchedSeconds.size / denom, 1);
      const pct = Math.round(ratio * 100);
      barFill.style.width = pct + '%';
      progBar.setAttribute('aria-valuenow', String(pct));
      const nearEnd = (duration - lastAllowed) <= 2;
      if (ratio >= WATCH_THRESHOLD || nearEnd){
        nextBtn.disabled = false;
        msg.className = 'ok';
        msg.textContent = '시청 완료! 설문으로 이동할 수 있습니다.';
      }
    }
  }, { signal: stepAbort.signal });

  nextBtn.addEventListener('click', ()=>{ renderSurveyStep(item, index); }, { signal: stepAbort.signal });

  const wrap = el('div', { className:'video-wrap' }, [header, v, progBar, msg, el('div', { className:'row' }, [nextBtn])]);
  $stage.appendChild(wrap);
}

function renderSurveyStep(item, index){
  stepAbort?.abort();
  stepAbort = new AbortController();

  $stage.innerHTML = '';
  const formEl = el('form', { className:'card' });
  const title = el('div', { innerHTML: `<span class="badge">${index+1} / ${order.length}</span><b>${item.label} — 설문</b>` });
  formEl.appendChild(title);

  questions.forEach((q,i)=>{
    const name = `${item.id}_q${i}`;
    const block = el('div', { className:'q' });
    block.appendChild(el('div', { className:'q-title', textContent: q }));

    // 리커트 (1~5) - 모바일 친화 pill 버튼
    const likertWrap = el('div', { className:'likert-wrap' });
    const likert = el('div', { className:'likert' });
    const inner = el('div', { className:'likert-inner' });

    const ariaMap = {1:'전혀 아니다',2:'',3:'보통이다',4:'',5:'매우 그렇다'};
    for (let v=1; v<=5; v++){
      const inputId = `${name}_${v}`;
      const pill = el('label', { className:'pill', htmlFor: inputId });
      const input = el('input', {
        type:'radio', id:inputId, name, value:String(v),
        'aria-label': ariaMap[v] ? `${v} (${ariaMap[v]})` : String(v),
        required: (v === 1) // 그룹 내 하나만 required면 유효성 검사 동작
      });
      pill.appendChild(input);
      pill.appendChild(el('span', { textContent: String(v) }));
      inner.appendChild(pill);
    }
    likert.appendChild(inner);
    likertWrap.appendChild(likert);
    block.appendChild(likertWrap);

    // 1/3/5 앵커 텍스트
    const legend = el('div', { className:'likert-legend' }, [
      el('span', { textContent:'1 전혀 아니다' }),
      el('span', { textContent:'' }),
      el('span', { textContent:'3 보통이다' }),
      el('span', { textContent:'' }),
      el('span', { textContent:'5 매우 그렇다' })
    ]);
    block.appendChild(legend);

    formEl.appendChild(block);
  });

  const backBtn = el('button', { type:'button', className:'btn', textContent:'이전 (영상 다시 보기)' });
  const nextBtn = el('button', { type:'submit', className:'btn', textContent:(index === order.length - 1) ? '최종 제출' : '다음 영상으로' });
  const actions = el('div', { className:'actions' }, [el('div', { className:'row' }, [backBtn, nextBtn])]);
  formEl.appendChild(actions);

  formEl.addEventListener('submit', (e)=>{
    e.preventDefault();
    const vals = [];
    let ok = true;

    questions.forEach((_,i)=>{
      const picked = formEl.querySelector(`input[name="${item.id}_q${i}"]:checked`);
      if (!picked) ok = false; else vals.push(Number(picked.value));
    });

    if (!ok){ alert('모든 문항에 응답해주세요.'); return; }

    // 디버그: 제출 직전 6개 수집 확인
    console.log(`${item.id} answers length =`, vals.length, vals);

    answers[item.id] = vals;
    if (index === order.length - 1) submitAll();
    else renderVideoStep(order[index+1], index+1, order.length);
  }, { signal: stepAbort.signal });

  backBtn.addEventListener('click', ()=>{ renderVideoStep(item, index, order.length); }, { signal: stepAbort.signal });

  $stage.appendChild(formEl);
}

/* =========================
 * 4) 제출 로직 (hidden form + iframe)
 * ========================= */
function submitAll(){
  if (posting) return;
  posting = true;

  const payload = {
    sessionId,
    userAgent: navigator.userAgent,
    order: order.map(o=>o.id),
    answers,
    timestamp: new Date().toISOString()
  };

  $payload.value = JSON.stringify(payload);

  $stage.innerHTML = `
    <div class="card">
      <p>제출 중…</p>
      <p class="dim">창을 닫지 말고 잠시만 기다려주세요.</p>
    </div>
  `;

  submitTimer = setTimeout(()=>{
    if (!posting) return;
    posting = false;
    $stage.innerHTML = `
      <div class="card">
        <p class="warn">제출 확인 신호가 지연되고 있습니다.</p>
        <p class="dim">네트워크 상태를 확인하시거나, 잠시 후 다시 시도해주세요.<br/>응답은 중복 제출되어도 서버에서 처리됩니다.</p>
      </div>
    `;
  }, SUBMIT_TIMEOUT_MS);

  $form.submit();
}

// iframe onload → 성공 처리
$sink.addEventListener('load', ()=>{
  if (!posting) return;
  posting = false;
  clearTimeout(submitTimer);
  $stage.innerHTML = `
    <div class="card">
      <p class="ok">제출이 완료되었습니다. 감사합니다!</p>
      <div class="dim">응답이 스프레드시트에 저장되었습니다.</div>
    </div>
  `;
});

/* =========================
 * 5) 시작
 * ========================= */
renderVideoStep(order[0], 0, order.length);
</script>
</body>
</html>
