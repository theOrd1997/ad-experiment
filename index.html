<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ê´‘ê³  ì˜ìƒ ì‹œì²­ ë°˜ì‘ ì„¤ë¬¸</title>

<!-- ìºì‹œ ë¬´ë ¥í™” ê¶Œì¥(ì •ì  í˜¸ìŠ¤íŒ… ì‹œ êµ¬ë²„ì „ ì”ì¡´ ë°©ì§€) -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />

<style>
  :root{
    --gap:14px; --fg:#222; --muted:#666; --line:#e5e7eb; --ok:#0a7c0a; --warn:#b00; --brand:#111;
  }
  html,body{margin:0;padding:0;background:#fff;color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;line-height:1.6}
  .wrap{max-width:860px;margin:24px auto;padding:0 16px}
  h1{font-size:1.4rem;margin:.2rem 0 .5rem}
  .dim{color:var(--muted)}
  .card{border:1px solid var(--line);border-radius:14px;padding:16px;box-shadow:0 1px 4px rgba(0,0,0,.03);margin-top:var(--gap)}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#f2f2f2;font-size:.82rem;margin-right:6px}
  .video-wrap{display:grid;gap:10px}
  video{width:100%;max-height:60vh;background:#000;border-radius:12px}
  .progress{height:8px;background:#eee;border-radius:999px;overflow:hidden}
  .progress>div{height:100%;background:#2f6;width:0%;transition:width .2s}
  .ok{color:var(--ok)}
  .warn{color:var(--warn)}
  .btn{cursor:pointer;border:0;padding:10px 14px;border-radius:10px;background:var(--brand);color:#fff;font-weight:600}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  .row{display:grid;gap:8px;grid-auto-flow:column;justify-content:start}
  .q{margin:14px 0}
  .likert{display:flex;gap:10px;flex-wrap:wrap}
  .likert label{border:1px solid var(--line);padding:6px 10px;border-radius:8px;cursor:pointer}
  .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
</style>
</head>
<body>
  <div class="wrap">
    <h1>ê´‘ê³  ì˜ìƒ ì‹œì²­ ë°˜ì‘ ì„¤ë¬¸</h1>
    <p class="dim"><b>ê° ì˜ìƒì€ ëê¹Œì§€ ì‹œì²­</b>í•´ì•¼ ì„¤ë¬¸ìœ¼ë¡œ ì´ë™í•  ìˆ˜ ìˆì–´ìš”.</p>

    <!-- ìˆ¨ì€ iframe: ì‘ë‹µ ìˆ˜ì‹ ìš© -->
    <iframe name="sink" id="sink" title="ì‘ë‹µ ì „ì†¡ ìƒíƒœ" class="sr-only"></iframe>

    <!-- ìˆ¨ì€ form: ìµœì¢… ì œì¶œìš© (data=<JSON>) -->
    <form id="submitForm"
          action="https://script.google.com/macros/s/AKfycbywBmhFjK3CTJ1zqqkUf0n6XtDBwpa8-O5fUPYkZeYLfRUmXO5TdMMiESTjcic3AMphRg/exec"
          method="POST" target="sink" class="sr-only" aria-hidden="true">
      <input type="hidden" name="data" id="payload" />
    </form>

    <div id="stage" class="card">ë¡œë”© ì¤‘â€¦</div>
  </div>

<script>
/* =========================
 * 0) ì„¤ì • & ìƒìˆ˜
 * ========================= */
const WATCH_THRESHOLD = 0.98;               // ì‹œì²­ë¥  ê¸°ì¤€
const SEEK_TOLERANCE = 0.75;                // ì´ˆ ë‹¨ìœ„: ê°•ì œ ì í”„ í—ˆìš©ì¹˜
const MAX_PLAYBACK = 1.25;                  // ë°°ì† ì œí•œ
const SUBMIT_TIMEOUT_MS = 10_000;           // ì œì¶œ ëŒ€ê¸° íƒ€ì„ì•„ì›ƒ

const videos = [
  { id: "high", label: "ì˜ìƒ A", src: "https://raw.githubusercontent.com/theOrd1997/ad-experiment/main/high_originality.mp4" },
  { id: "low",  label: "ì˜ìƒ B", src: "https://raw.githubusercontent.com/theOrd1997/ad-experiment/main/low_originality.mp4" }
];

// âœ… 6ë¬¸í•­(í’ˆì§ˆ 4 + ë…ì°½ì„± 2)
const questions = [
  "ì´ ê´‘ê³ ëŠ” ì „ë°˜ì ìœ¼ë¡œ ì˜ ë§Œë“¤ì–´ì¡Œë‹¤.",
  "ì´ ê´‘ê³ ëŠ” ë¸Œëœë“œ ì œí’ˆì„ ì˜ í‘œí˜„í•˜ì˜€ë‹¤.",
  "ì´ ê´‘ê³ ëŠ” ë¸Œëœë“œì™€ ì˜ ì–´ìš¸ë¦°ë‹¤.",
  "ì´ ê´‘ê³ ëŠ” ì‹œê°ì  ì™„ì„±ë„ê°€ ë†’ë‹¤.",
  "ì´ ì˜ìƒì€ ìƒˆë¡­ê³  ë…ì°½ì ì¸ ì•„ì´ë””ì–´ë¥¼ ë³´ì—¬ì¤€ë‹¤.",
  "ì´ ì˜ìƒì€ ì˜ˆìƒ ë°–ì˜ ë…íŠ¹í•œ í‘œí˜„ ë°©ì‹ì„ ë‹´ê³  ìˆë‹¤."
];

/* =========================
 * 1) ê³µìš© ìœ í‹¸
 * ========================= */
const $stage   = document.getElementById('stage');
const $sink    = document.getElementById('sink');
const $form    = document.getElementById('submitForm');
const $payload = document.getElementById('payload');

const sessionId = (crypto?.getRandomValues)
  ? crypto.getRandomValues(new Uint32Array(4)).join('-')
  : String(Date.now());

// Fisherâ€“Yates ì…”í”Œ
function shuffleInPlace(arr){
  for(let i = arr.length - 1; i > 0; i--){
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

// element ìƒì„± í—¬í¼
function el(tag, props={}, children=[]){
  const node = document.createElement(tag);
  Object.assign(node, props);
  (Array.isArray(children) ? children : [children]).forEach(c=>{
    if (c==null) return;
    node.appendChild(typeof c === 'string' ? document.createTextNode(c) : c);
  });
  return node;
}

/* =========================
 * 2) ìƒíƒœ
 * ========================= */
const order = shuffleInPlace(videos.slice());
const answers = {};               // { high:[..], low:[..] }
let posting = false;              // ì œì¶œ ì¤‘ í”Œë˜ê·¸
let submitTimer = null;           // íƒ€ì„ì•„ì›ƒ í•¸ë“¤
let stepAbort = null;             // ë‹¨ê³„ë³„ ì´ë²¤íŠ¸ ì •ë¦¬ìš© AbortController

/* =========================
 * 3) ë‹¨ê³„ ë Œë”ëŸ¬
 * ========================= */
function renderVideoStep(item, index, total){
  // ì´ì „ ë‹¨ê³„ ì´ë²¤íŠ¸ ì •ë¦¬
  stepAbort?.abort();
  stepAbort = new AbortController();

  $stage.innerHTML = '';
  const header = el('div', { innerHTML: `<span class="badge">${index+1} / ${total}</span><b>${item.label}</b>` });

  const v = el('video', {
    src: item.src, controls: true, playsInline: true, preload: 'metadata'
  });

  const progBar = el('div', { className:'progress', role:'progressbar', 'aria-valuemin':0, 'aria-valuemax':100 });
  const barFill = el('div'); progBar.appendChild(barFill);
  const msg = el('div', { className:'dim', textContent:'ì˜ìƒì„ ëê¹Œì§€ ì‹œì²­í•´ì£¼ì„¸ìš”.' });
  const nextBtn = el('button', { className:'btn', textContent:'ë‹¤ìŒ (ì„¤ë¬¸ìœ¼ë¡œ ì´ë™)', disabled:true });

  // ì‹œì²­ ì¶”ì 
  let lastAllowed = 0;
  let duration = 0;
  const watchedSeconds = new Set();

  v.addEventListener('loadedmetadata', ()=>{
    duration = Math.max(0, v.duration || 0);
  }, { signal: stepAbort.signal });

  v.addEventListener('seeking', ()=>{
    if (v.currentTime > lastAllowed + SEEK_TOLERANCE){
      v.currentTime = lastAllowed;
    }
  }, { signal: stepAbort.signal });

  v.addEventListener('ratechange', ()=>{
    if (v.playbackRate > MAX_PLAYBACK) v.playbackRate = MAX_PLAYBACK;
  }, { signal: stepAbort.signal });

  document.addEventListener('visibilitychange', ()=>{
    if (document.hidden && !v.paused) v.pause();
  }, { signal: stepAbort.signal });

  v.addEventListener('error', ()=>{
    msg.className = 'warn';
    msg.textContent = 'ì˜ìƒì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ìƒíƒœë¥¼ í™•ì¸í•œ ë’¤ ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.';
  }, { signal: stepAbort.signal });

  v.addEventListener('timeupdate', ()=>{
    lastAllowed = Math.max(lastAllowed, v.currentTime);
    watchedSeconds.add(Math.floor(v.currentTime));

    if (duration > 0){
      // ë¶„ëª¨ ë°˜ì˜¬ë¦¼ ë³´ì •(ë©”íƒ€ë°ì´í„° ë¶€ì •í™•ì„± ì™„í™”)
      const denom = Math.max(1, Math.round(duration));
      const ratio = Math.min(watchedSeconds.size / denom, 1);
      const pct = Math.round(ratio * 100);
      barFill.style.width = pct + '%';
      progBar.setAttribute('aria-valuenow', String(pct));

      const nearEnd = (duration - lastAllowed) <= 2;
      if (ratio >= WATCH_THRESHOLD || nearEnd){
        nextBtn.disabled = false;
        msg.className = 'ok';
        msg.textContent = 'ì‹œì²­ ì™„ë£Œ! ì„¤ë¬¸ìœ¼ë¡œ ì´ë™í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
      }
    }
  }, { signal: stepAbort.signal });

  nextBtn.addEventListener('click', ()=>{
    renderSurveyStep(item, index);
  }, { signal: stepAbort.signal });

  const wrap = el('div', { className:'video-wrap' }, [
    header, v, progBar, msg,
    el('div', { className:'row' }, [nextBtn])
  ]);

  $stage.appendChild(wrap);
}

function renderSurveyStep(item, index){
  stepAbort?.abort();
  stepAbort = new AbortController();

  $stage.innerHTML = '';
  const formEl = el('form', { className:'card' });

  const title = el('div', { innerHTML: `<span class="badge">${index+1} / ${order.length}</span><b>${item.label} â€” ì„¤ë¬¸</b>` });
  formEl.appendChild(title);

  questions.forEach((q,i)=>{
    const name = `${item.id}_q${i}`;
    const block = el('div', { className:'q' });
    block.appendChild(el('div', { textContent: q }));

    const likert = el('div', { className:'likert' });
    for (let v=1; v<=5; v++){
      const inputId = `${name}_${v}`;
      const input = el('input', {
        type:'radio',
        id: inputId,
        name,
        value: String(v),
        // ê·¸ë£¹ ì¤‘ í•˜ë‚˜ë§Œ requiredë©´ HTML5 ìœ íš¨ì„± ê²€ì‚¬ í†µê³¼
        required: (v === 1)
      });
      // ë¼ë²¨ë¡œ ê°ì‹¸ í´ë¦­ì˜ì—­â†‘ ì ‘ê·¼ì„±â†‘
      const label = el('label', { htmlFor: inputId });
      label.appendChild(input);
      label.appendChild(document.createTextNode(` ${v}`));
      likert.appendChild(label);
    }
    block.appendChild(likert);
    formEl.appendChild(block);
  });

  const backBtn = el('button', { type:'button', className:'btn', textContent:'ì´ì „ (ì˜ìƒ ë‹¤ì‹œ ë³´ê¸°)' });
  const nextBtn = el('button', { type:'submit', className:'btn',
    textContent: (index === order.length - 1) ? 'ìµœì¢… ì œì¶œ' : 'ë‹¤ìŒ ì˜ìƒìœ¼ë¡œ'
  });

  formEl.appendChild(el('div', { className:'row' }, [backBtn, nextBtn]));

  formEl.addEventListener('submit', (e)=>{
    e.preventDefault();
    const vals = [];
    let ok = true;

    questions.forEach((_,i)=>{
      const picked = formEl.querySelector(`input[name="${item.id}_q${i}"]:checked`);
      if (!picked) ok = false;
      else vals.push(Number(picked.value));
    });

    if (!ok){
      alert('ëª¨ë“  ë¬¸í•­ì— ì‘ë‹µí•´ì£¼ì„¸ìš”.');
      return;
    }

    // ğŸ” ë””ë²„ê·¸: ì œì¶œ ì§ì „ ê¸¸ì´ í™•ì¸(1~2íšŒ ì ê²€ í›„ ì£¼ì„ ì²˜ë¦¬í•´ë„ ë©ë‹ˆë‹¤)
    console.log(`${item.id} answers length =`, vals.length, vals);

    answers[item.id] = vals;

    if (index === order.length - 1){
      submitAll();
    } else {
      renderVideoStep(order[index+1], index+1, order.length);
    }
  }, { signal: stepAbort.signal });

  backBtn.addEventListener('click', ()=>{
    renderVideoStep(item, index, order.length);
  }, { signal: stepAbort.signal });

  $stage.appendChild(formEl);
}

/* =========================
 * 4) ì œì¶œ ë¡œì§ (hidden form + iframe)
 * ========================= */
function submitAll(){
  if (posting) return; // ì´ì¤‘ ì œì¶œ ë°©ì§€
  posting = true;

  const payload = {
    sessionId,
    userAgent: navigator.userAgent,
    order: order.map(o=>o.id),
    answers,
    timestamp: new Date().toISOString()
  };

  $payload.value = JSON.stringify(payload);

  // UI: ì§„í–‰ì¤‘
  $stage.innerHTML = `
    <div class="card">
      <p>ì œì¶œ ì¤‘â€¦</p>
      <p class="dim">ì°½ì„ ë‹«ì§€ ë§ê³  ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
    </div>
  `;

  // í´ë°± íƒ€ì„ì•„ì›ƒ
  submitTimer = setTimeout(()=>{
    if (!posting) return;
    posting = false;
    $stage.innerHTML = `
      <div class="card">
        <p class="warn">ì œì¶œ í™•ì¸ ì‹ í˜¸ê°€ ì§€ì—°ë˜ê³  ìˆìŠµë‹ˆë‹¤.</p>
        <p class="dim">ë„¤íŠ¸ì›Œí¬ ìƒíƒœë¥¼ í™•ì¸í•˜ì‹œê±°ë‚˜, ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.<br/>ì‘ë‹µì€ ì¤‘ë³µ ì œì¶œë˜ì–´ë„ ì„œë²„ì—ì„œ ì²˜ë¦¬ë©ë‹ˆë‹¤.</p>
      </div>
    `;
  }, SUBMIT_TIMEOUT_MS);

  $form.submit();
}

// iframe onload â†’ ì„±ê³µ ì²˜ë¦¬
$sink.addEventListener('load', ()=>{
  if (!posting) return;               // ì´ˆê¸° onload ë¬´ì‹œ
  posting = false;
  clearTimeout(submitTimer);
  $stage.innerHTML = `
    <div class="card">
      <p class="ok">ì œì¶œì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤!</p>
      <div class="dim">ì‘ë‹µì´ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.</div>
    </div>
  `;
});

/* =========================
 * 5) ì‹œì‘
 * ========================= */
renderVideoStep(order[0], 0, order.length);
</script>
</body>
</html>
