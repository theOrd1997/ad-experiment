<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>사전 설문: 인구통계 (나이·성별)</title>
<style>
  :root { --gap: 14px; }
  *, *::before, *::after { box-sizing: border-box; }
  body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; line-height: 1.6; margin: 24px auto; max-width: 720px; padding: 0 16px; background:#f7f8fb;}
  h1 { font-size: 1.8rem; margin: 0 0 8px; }
  .muted{ color:#667085; }
  .card { border:1px solid #e6e8ec; border-radius:16px; padding:20px; box-shadow:0 1px 6px rgba(0,0,0,.04); background:#fff; margin-top: var(--gap); }
  .row  { display:grid; gap:8px; margin-top:12px; }
  .label{ font-weight:700; }
  .opt { display:flex; flex-wrap:wrap; gap:10px; margin-top:6px; }
  .opt label{ display:flex; align-items:center; gap:8px; padding:8px 12px; border:1px solid #e6e8ec; border-radius:999px; cursor:pointer; background:#fafbff; }
  input[type="number"], input[type="text"]{ width: 200px; padding:10px 12px; border:1px solid #d0d5dd; border-radius:10px; background:#fff; }
  .hidden{ display:none !important; }
  .ok{ color:#039855; }
  .err{ color:#d92d20; }
  .info{ color:#344054; }
  button{ padding:12px 16px; border:0; border-radius:12px; background:#111827; color:#fff; font-weight:700; cursor:pointer; width: 100%; }
  button[disabled]{ opacity:.6; cursor:not-allowed; }
  .footer{ margin-top:16px; font-size:.9rem; color:#667085; }
</style>
</head>
<body>
  <h1>사전 설문: 인구통계 (나이·성별)</h1>
  <p class="muted">본 설문은 연구 목적에 한해 사용되며, 응답은 익명으로 저장됩니다.</p>

  <!-- 응답 수신 전용 숨은 iframe (CORS 회피) -->
  <iframe name="sink" id="sink" style="display:none;"></iframe>

  <div class="card">
    <!-- ★ action에 Apps Script 웹앱의 최신 /exec URL을 넣으세요 -->
    <form id="survey" action="https://script.google.com/macros/s/AKfycbxRphkBzMvzpU6JaxJljs6B_mh71cTehLD5wMIboOdRsI_YU4LNBgfKUmoEkM2saLl8Pw/exec"
          method="POST" target="sink" onsubmit="return __safeSubmit(event)" novalidate>
      <div class="row">
        <div class="label">나이 <span class="muted">(숫자, 14–100)</span></div>
        <input id="age" name="age" type="number" min="14" max="100" inputmode="numeric" placeholder="예: 24" required />
      </div>

      <div class="row">
        <div class="label">성별</div>
        <div class="opt" role="radiogroup" aria-label="성별">
          <label><input type="radio" name="gender" value="male" required>남성</label>
          <label><input type="radio" name="gender" value="female">여성</label>
          <label><input type="radio" name="gender" value="nonbinary">논바이너리</label>
          <label><input type="radio" name="gender" value="prefer_not">응답 거부</label>
          <label><input type="radio" name="gender" value="other">기타</label>
        </div>
        <input id="gender_text" name="gender_text" class="hidden" type="text" placeholder="기타 선택 시 상세 입력" />
      </div>

      <!-- 사용자 에이전트(선택) -->
      <input type="hidden" name="ua" id="ua" value="" />

      <div class="row" style="margin-top:14px;">
        <button id="submitBtn" type="submit">제출</button>
        <div id="msg" class="info"></div>
      </div>
    </form>

    <div class="footer">
      제출 후 메시지가 보이지 않더라도, 스프레드시트에 행이 추가되면 저장은 성공입니다.
    </div>
  </div>

<script>
(function(){
  // 외부 스크립트 충돌 방지용 "방탄" 제출 루틴
  const $ = sel => document.querySelector(sel);
  const form = $('#survey');
  const msg  = $('#msg');
  const btn  = $('#submitBtn');
  const genderText = $('#gender_text');
  const sink = document.getElementById('sink');

  // UA 기록(선택)
  document.getElementById('ua').value = navigator.userAgent;

  // “기타” 선택 시 상세 입력 토글
  document.addEventListener('change', () => {
    const g = document.querySelector('input[name="gender"]:checked')?.value;
    if (g === 'other') { genderText.classList.remove('hidden'); genderText.required = true; }
    else { genderText.classList.add('hidden'); genderText.required = false; genderText.value=''; }
  });

  // 단순 검증
  function validate(){
    const age = Number($('#age').value);
    const g   = document.querySelector('input[name="gender"]:checked')?.value || '';
    if (!Number.isFinite(age) || age < 14 || age > 100) return '나이는 14–100 사이여야 합니다.';
    if (!g) return '성별을 선택해주세요.';
    if (g === 'other' && genderText.value.trim().length === 0) return '기타 선택 시 상세를 입력해주세요.';
    return '';
  }

  // 중복 제출 방지(기기 단위)
  if (localStorage.getItem('demographic_submitted') === '1') {
    btn.disabled = true;
    msg.textContent = '이미 제출한 것으로 감지되었습니다.';
    msg.className = 'err';
  }

  // 다른 스크립트가 submit을 가로채지 못하도록 onsubmit 경로 고정
  window.__posting = false;
  window.__safeSubmit = function(ev){
    const err = validate();
    if (err){
      ev.preventDefault();
      msg.textContent = err; msg.className = 'err';
      return false;
    }
    if (localStorage.getItem('demographic_submitted') === '1'){
      ev.preventDefault();
      msg.textContent = '이미 제출한 것으로 감지되었습니다.'; msg.className = 'err';
      return false;
    }
    window.__posting = true;
    btn.disabled = true;
    msg.textContent = '제출 중...'; msg.className = 'info';
    // return true → 브라우저 기본 제출(iframe POST) 진행
    return true;
  };

  // iframe이 로드되면 제출 완료로 처리
  sink.addEventListener('load', () => {
    if (!window.__posting) return; // 초기 로드 무시
    window.__posting = false;
    localStorage.setItem('demographic_submitted','1');
    msg.textContent = '제출이 완료되었습니다.'; msg.className = 'ok';
    form.reset();
    btn.disabled = true; // 재제출 방지(원하면 제거)
    // 다음 페이지로 넘기려면 아래 주석 해제
    // location.href = './next.html';
  });
})();
</script>
</body>
</html>
