<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>광고 영상 시청 반응 설문</title>
<style>
  :root { --gap: 14px; }
  body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; line-height: 1.6; margin: 24px auto; max-width: 860px; padding: 0 16px; }
  .card { border: 1px solid #ddd; border-radius: 14px; padding: 16px; box-shadow: 0 1px 4px rgba(0,0,0,.03); margin-top: var(--gap); }
  .badge { display:inline-block; padding:2px 8px; border-radius:999px; background:#f2f2f2; font-size:.82rem; margin-right:6px;}
  .video-wrap { display: grid; gap: 10px; }
  video { width: 100%; max-height: 60vh; background:#000; border-radius:12px; }
  .progress { height: 8px; background: #eee; border-radius: 999px; overflow: hidden; }
  .progress > div { height: 100%; background: #2f6; width: 0%; transition: width .2s; }
  .dim { color:#666; }
  .ok { color:#0a7c0a; }
  .warn { color:#b00; }
  .btn { cursor:pointer; border:0; padding:10px 14px; border-radius:10px; background:#111; color:#fff; font-weight:600; }
  .btn[disabled]{ opacity:.5; cursor:not-allowed; }
  .q { margin: 14px 0; }
  .likert { display:flex; gap:10px; flex-wrap:wrap; }
  .likert label { border:1px solid #ddd; padding:6px 10px; border-radius:8px; cursor:pointer; }
  .row { display:grid; gap:8px; }
</style>
</head>
<body>
  <h1>광고 영상 시청 반응 설문</h1>
  <p class="dim"><b>각 영상은 끝까지 시청</b>해야 설문으로 이동할 수 있어요.</p>

  <div id="stage" class="card">로딩 중…</div>

<script>
/* ===== 0) 설정 ===== */
const WEB_APP_URL = "https://script.google.com/macros/library/d/1YjBuqhujzBtESON0PZN5dWorDGSvtY8pWl4xh6oHFFR7RanFsGEdUG66/2";
const WATCH_THRESHOLD = 0.98; // 98% 이상 시청해야 완료 처리
const videos = [
  { id: "high", label: "영상 A", src: "https://www.dropbox.com/scl/fi/bbmr9chryaiwrgbg64biz/high_originality.mp4?rlkey=6pn4584iwg7as5y89aht7k5ys&st=a49pald0&raw=1" },
  { id: "low",  label: "영상 B", src: "https://www.dropbox.com/scl/fi/gpd95qhvwid3xxv9hbyur/low_originality.mp4?rlkey=1wvalrivbwtd6v95onarxlf5b&st=ow4mi1xb&raw=1" }
];
const questions = [
  "이 광고는 전반적으로 잘 만들어졌다.",
  "이 광고는 브랜드 제품을 잘 표현하였다.",
  "이 광고는 브랜드와 잘 어울린다.",
  "이 광고는 시각적 완성도가 높다."
];

/* ===== 1) 유틸 ===== */
const shuffle = arr => arr.map(v=>[Math.random(),v]).sort((a,b)=>a[0]-b[0]).map(x=>x[1]);
const stage = document.getElementById('stage');
const sessionId = crypto.getRandomValues(new Uint32Array(4)).join('-');

/* ===== 2) 영상 시청 단계 ===== */
function renderVideoStep(item, index, total){
  stage.innerHTML = "";
  const wrap = document.createElement('div'); wrap.className = 'video-wrap';

  const header = document.createElement('div');
  header.innerHTML = `<span class="badge">${index+1} / ${total}</span><b>${item.label}</b>`;

  const v = document.createElement('video');
  v.src = item.src; v.controls = true; v.playsInline = true; v.preload = 'metadata';

  let lastAllowedTime = 0, watched = new Set(), duration = 0;
  v.addEventListener('loadedmetadata', ()=>{ duration = v.duration || 0; });
  v.addEventListener('seeking', ()=>{
    if (v.currentTime > lastAllowedTime + 0.75) v.currentTime = lastAllowedTime;
  });
  v.addEventListener('ratechange', ()=>{ if (v.playbackRate > 1.25) v.playbackRate = 1.25; });
  document.addEventListener('visibilitychange', ()=>{ if (document.hidden && !v.paused) v.pause(); });

  const progress = document.createElement('div'); progress.className='progress';
  const bar = document.createElement('div'); progress.appendChild(bar);
  const msg = document.createElement('div'); msg.className='dim'; msg.textContent='영상을 끝까지 시청해주세요.';
  const nextBtn = document.createElement('button'); nextBtn.className='btn'; nextBtn.textContent='다음 (설문으로 이동)'; nextBtn.disabled = true;

  v.addEventListener('timeupdate', ()=>{
    lastAllowedTime = Math.max(lastAllowedTime, v.currentTime);
    watched.add(Math.floor(v.currentTime));
    if (duration > 0){
      const ratio = Math.min(watched.size / Math.ceil(duration), 1);
      bar.style.width = (ratio*100).toFixed(1) + '%';

      // nearEnd 허용 (사용자 경험 개선)
      const nearEnd = duration > 0 && (duration - lastAllowedTime) <= 2;

      if (ratio >= WATCH_THRESHOLD || nearEnd){
        nextBtn.disabled = false;
        msg.className = 'ok';
        msg.textContent = '시청 완료! 설문으로 이동할 수 있습니다.';
      }
    }
  });

  wrap.appendChild(header);
  wrap.appendChild(v);
  wrap.appendChild(progress);
  wrap.appendChild(msg);
  const foot = document.createElement('div'); foot.className='row';
  foot.appendChild(nextBtn); wrap.appendChild(foot);
  stage.appendChild(wrap);

  nextBtn.addEventListener('click', ()=> renderSurveyStep(item, index));
}

/* ===== 3) 설문 단계 ===== */
const answers = {}; // { high:[..], low:[..] }
function renderSurveyStep(item, index){
  stage.innerHTML = "";
  const form = document.createElement('form'); form.className='card';
  const title = document.createElement('div');
  title.innerHTML = `<span class="badge">${index+1} / ${order.length}</span><b>${item.label} — 설문</b>`;
  form.appendChild(title);

  questions.forEach((q,i)=>{
    const block = document.createElement('div'); block.className='q';
    const id = `${item.id}_q${i}`;
    block.innerHTML = `<div>${q}</div>`;
    const likert = document.createElement('div'); likert.className='likert';
    for (let v=1; v<=5; v++){
      const lab = document.createElement('label');
      lab.innerHTML = `<input type="radio" name="${id}" value="${v}" required> ${v}`;
      likert.appendChild(lab);
    }
    block.appendChild(likert);
    form.appendChild(block);
  });

  const footer = document.createElement('div'); footer.className='row';
  const backBtn = document.createElement('button'); backBtn.type='button'; backBtn.className='btn'; backBtn.textContent='이전 (영상 다시 보기)';
  const nextBtn = document.createElement('button'); nextBtn.type='submit'; nextBtn.className='btn';
  nextBtn.textContent = (index === order.length-1) ? '최종 제출' : '다음 영상으로';
  footer.appendChild(backBtn); footer.appendChild(nextBtn); form.appendChild(footer);

  form.addEventListener('submit', e=>{
    e.preventDefault();
    const vals = []; let ok = true;
    questions.forEach((_,i)=>{
      const r = form.querySelector(`input[name="${item.id}_q${i}"]:checked`);
      if(!r) ok=false; else vals.push(Number(r.value));
    });
    if(!ok) return alert('모든 문항에 응답해주세요.');
    answers[item.id] = vals;
    if (index === order.length-1) submitAll(); else renderVideoStep(order[index+1], index+1, order.length);
  });

  backBtn.addEventListener('click', ()=> renderVideoStep(item, index, order.length));
  stage.appendChild(form);
}

/* ===== 4) 제출(Apps Script로 POST) ===== */
async function submitAll(){
  const payload = {
    sessionId,
    userAgent: navigator.userAgent,
    order: order.map(o=>o.id),
    answers,
    timestamp: new Date().toISOString()
  };
  stage.innerHTML = '<p>제출 중…</p>';
  try{
    // ★ preflight 회피: 폼 인코딩 + data= 에 JSON 문자열
    const res = await fetch(WEB_APP_URL, {
      method:'POST',
      headers:{
        'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'
      },
      body: 'data=' + encodeURIComponent(JSON.stringify(payload))
    });

    if (!res.ok) {
      const txt = await res.text().catch(()=> '');
      throw new Error(`서버 오류 (status ${res.status}) ${txt}`);
    }

    // Apps Script가 JSON 응답을 줌
    const data = await res.json().catch(() => ({}));
    stage.innerHTML = `<div class="card"><p class="ok">제출이 완료되었습니다. 감사합니다!</p><div class="dim">응답 ID: ${data.id || '—'}</div></div>`;
  }catch(err){
    stage.innerHTML = `<div class="card"><p class="warn">제출 중 오류가 발생했습니다. 인터넷 연결을 확인하고 다시 시도해주세요.</p><pre class="dim" style="white-space:pre-wrap">${String(err)}</pre></div>`;
  }
}

/* ===== 5) 시작: 순서 랜덤 후 1번 영상부터 ===== */
const order = shuffle(videos.slice());
renderVideoStep(order[0], 0, order.length);
</script>
</body>
</html>
